<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React | ğŸ’«Viaã®blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/babe.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.795a5f26.css" as="style"><link rel="preload" href="/assets/js/app.1a8c5bfd.js" as="script"><link rel="preload" href="/assets/js/2.dec9ee96.js" as="script"><link rel="preload" href="/assets/js/29.d0462958.js" as="script"><link rel="prefetch" href="/assets/js/10.8be9e924.js"><link rel="prefetch" href="/assets/js/11.44f5bc5a.js"><link rel="prefetch" href="/assets/js/12.13eb32e8.js"><link rel="prefetch" href="/assets/js/13.0b29cc16.js"><link rel="prefetch" href="/assets/js/14.a078733b.js"><link rel="prefetch" href="/assets/js/15.11a9ccdf.js"><link rel="prefetch" href="/assets/js/16.a2c3d2a9.js"><link rel="prefetch" href="/assets/js/17.980f556f.js"><link rel="prefetch" href="/assets/js/18.cea60c17.js"><link rel="prefetch" href="/assets/js/19.a727f28e.js"><link rel="prefetch" href="/assets/js/20.023d0896.js"><link rel="prefetch" href="/assets/js/21.fbabcbd6.js"><link rel="prefetch" href="/assets/js/22.13927ea0.js"><link rel="prefetch" href="/assets/js/23.a9bc2c2a.js"><link rel="prefetch" href="/assets/js/24.32925ff2.js"><link rel="prefetch" href="/assets/js/25.7aa0e1ed.js"><link rel="prefetch" href="/assets/js/26.ca27a143.js"><link rel="prefetch" href="/assets/js/27.8d248508.js"><link rel="prefetch" href="/assets/js/28.6d467f80.js"><link rel="prefetch" href="/assets/js/3.425531bf.js"><link rel="prefetch" href="/assets/js/30.8b05a0c2.js"><link rel="prefetch" href="/assets/js/31.7b9ee93d.js"><link rel="prefetch" href="/assets/js/32.309cfa25.js"><link rel="prefetch" href="/assets/js/33.11c2341a.js"><link rel="prefetch" href="/assets/js/4.c0667068.js"><link rel="prefetch" href="/assets/js/5.cd04caea.js"><link rel="prefetch" href="/assets/js/6.22a02351.js"><link rel="prefetch" href="/assets/js/7.3a87c63c.js"><link rel="prefetch" href="/assets/js/8.7771a382.js"><link rel="prefetch" href="/assets/js/9.167ee458.js">
    <link rel="stylesheet" href="/assets/css/0.styles.795a5f26.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/babe.png" alt="ğŸ’«Viaã®blog" class="logo"> <span class="site-name can-hide">ğŸ’«Viaã®blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ReactğŸŒ´" class="dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow down"></span></button> <button type="button" aria-label="ReactğŸŒ´" class="mobile-dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/reactCode.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  åº•å±‚
</a></li><li class="dropdown-item"><!----> <a href="/pages/react.html" class="nav-link">
  å…¶ä»–
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic ğŸ³" class="dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic ğŸ³" class="mobile-dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/pages/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/flutter.html" class="nav-link">
  Flutter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web ğŸŒ" class="dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web ğŸŒ" class="mobile-dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser.html" class="nav-link">
  æµè§ˆå™¨
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node â˜ï¸" class="dropdown-title"><span class="title">Node â˜ï¸</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node â˜ï¸" class="mobile-dropdown-title"><span class="title">Node â˜ï¸</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/pages/nest.html" class="nav-link">
  nest
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog âœğŸ»" class="dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blog âœğŸ»" class="mobile-dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/log.html" class="nav-link">
  æ—¥å¸¸è®°å½•
</a></li><li class="dropdown-item"><!----> <a href="/pages/blog.html" class="nav-link">
  åšå®¢
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ReactğŸŒ´" class="dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow down"></span></button> <button type="button" aria-label="ReactğŸŒ´" class="mobile-dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/reactCode.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  åº•å±‚
</a></li><li class="dropdown-item"><!----> <a href="/pages/react.html" class="nav-link">
  å…¶ä»–
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic ğŸ³" class="dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic ğŸ³" class="mobile-dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/pages/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/flutter.html" class="nav-link">
  Flutter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web ğŸŒ" class="dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web ğŸŒ" class="mobile-dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser.html" class="nav-link">
  æµè§ˆå™¨
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node â˜ï¸" class="dropdown-title"><span class="title">Node â˜ï¸</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node â˜ï¸" class="mobile-dropdown-title"><span class="title">Node â˜ï¸</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/node.html" class="nav-link">
  node
</a></li><li class="dropdown-item"><!----> <a href="/pages/nest.html" class="nav-link">
  nest
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog âœğŸ»" class="dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blog âœğŸ»" class="mobile-dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/log.html" class="nav-link">
  æ—¥å¸¸è®°å½•
</a></li><li class="dropdown-item"><!----> <a href="/pages/blog.html" class="nav-link">
  åšå®¢
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/reactCode.html#react-å¯åŠ¨æ¨¡å¼" class="sidebar-link">react å¯åŠ¨æ¨¡å¼</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/reactCode.html#å®Œæ•´æµç¨‹" class="sidebar-link">å®Œæ•´æµç¨‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#æ›´æ–°æµç¨‹" class="sidebar-link">æ›´æ–°æµç¨‹</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#update-è®¡ç®—" class="sidebar-link">Update è®¡ç®—</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#ä¼˜å…ˆçº§è°ƒåº¦" class="sidebar-link">ä¼˜å…ˆçº§è°ƒåº¦</a></li></ul></li><li><a href="/pages/reactCode.html#hooks-é—­åŒ…ç¼ºé™·" class="sidebar-link">hooks é—­åŒ…ç¼ºé™·</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/reactCode.html#setstate-åŒæ­¥å¼‚æ­¥" class="sidebar-link">setState åŒæ­¥å¼‚æ­¥</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#reactv15" class="sidebar-link">reactV15</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#reactv16-8" class="sidebar-link">reactV16.8</a></li></ul></li><li><a href="/pages/reactCode.html#æ—¶é—´åˆ‡ç‰‡" class="sidebar-link">æ—¶é—´åˆ‡ç‰‡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#requestframeanimation" class="sidebar-link">requestFrameAnimation</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#requestidlecallback" class="sidebar-link">requestIdleCallback</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#web-é€šä¿¡" class="sidebar-link">web é€šä¿¡</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#react-v16-0-0-raf-postmessage" class="sidebar-link">react v16.0.0 rAF + postMessage</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#react-v16-2-0-messagechannel" class="sidebar-link">react v16.2.0+ MessageChannel</a></li></ul></li><li><a href="/pages/reactCode.html#render-é˜¶æ®µ" class="sidebar-link">render é˜¶æ®µ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#diff" class="sidebar-link">diff</a></li></ul></li><li><a href="/pages/reactCode.html#commit-é˜¶æ®µ" class="sidebar-link">commit é˜¶æ®µ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/reactCode.html#hooks" class="sidebar-link">Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#usestate" class="sidebar-link">useState</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#useeffect" class="sidebar-link">useEffect</a></li></ul></li><li><a href="/pages/reactCode.html#context" class="sidebar-link">Context</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/reactCode.html#scheduler" class="sidebar-link">scheduler</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react"><a href="#react" class="header-anchor">#</a> React</h1> <p>è®¾è®¡ç†å¿µï¼šå¿«é€Ÿå“åº”<br>
åˆ¶çº¦å› ç´ ï¼šCPUã€IO<br>
èŠ‚æµé˜²æŠ–ï¼šé™åˆ¶è§¦å‘æ›´æ–°é¢‘ç‡<br>
React é€šè¿‡å¼‚æ­¥å¯ä¸­æ–­æ›´æ–°è§£å†³ CPU ç“¶é¢ˆï¼›<br>
å°†äººæœºäº¤äº’çš„æˆæœèå…¥ UI äº¤äº’ï¼Œä½¿å¼‚æ­¥æ— æ„ŸçŸ¥ã€‚</p> <h2 id="react-å¯åŠ¨æ¨¡å¼"><a href="#react-å¯åŠ¨æ¨¡å¼" class="header-anchor">#</a> react å¯åŠ¨æ¨¡å¼</h2> <ul><li>legacy æ¨¡å¼ï¼š<code>ReactDOM.render(&lt;App /&gt;, rootNode)</code>ã€‚è¿™æ˜¯å½“å‰ React app ä½¿ç”¨çš„æ–¹å¼ã€‚å½“å‰æ²¡æœ‰è®¡åˆ’åˆ é™¤æœ¬æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸ªæ¨¡å¼å¯èƒ½ä¸æ”¯æŒè¿™äº›æ–°åŠŸèƒ½ã€‚</li> <li>blocking æ¨¡å¼ï¼š <code>ReactDOM.createBlockingRoot(rootNode).render(&lt;App /&gt;)</code>ã€‚ç›®å‰æ­£åœ¨å®éªŒä¸­ã€‚ä½œä¸ºè¿ç§»åˆ° concurrent æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ã€‚</li> <li>concurrent æ¨¡å¼ï¼š <code>ReactDOM.createRoot(rootNode).render(&lt;App /&gt;)</code>ã€‚ç›®å‰åœ¨å®éªŒä¸­ï¼Œæœªæ¥ç¨³å®šä¹‹åï¼Œæ‰“ç®—ä½œä¸º React çš„é»˜è®¤å¼€å‘æ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å¼å¼€å¯äº†æ‰€æœ‰çš„æ–°åŠŸèƒ½ã€‚</li></ul> <h2 id="å®Œæ•´æµç¨‹"><a href="#å®Œæ•´æµç¨‹" class="header-anchor">#</a> å®Œæ•´æµç¨‹</h2> <h3 id="æ›´æ–°æµç¨‹"><a href="#æ›´æ–°æµç¨‹" class="header-anchor">#</a> æ›´æ–°æµç¨‹</h3> <p>è§¦å‘æ›´æ–°çš„æ–¹æ³•ï¼šReactDOM.render,setState,forceUpdate,useState,useReducer<br>
æ¯æ¬¡è§¦å‘æ›´æ–°ä¼šåˆ›å»ºä¸€ä¸ª Updateï¼Œå­˜å‚¨æ›´æ–°ç›¸å…³ã€‚ä¿å­˜åœ¨ pendingï¼ˆç¯çŠ¶é“¾è¡¨ï¼‰ä¸­</p> <p>dispatchAction è§¦å‘æ›´æ–°</p> <ul><li>(è°ƒåº¦)<code>scheduleUpdateOnFiber</code> è°ƒåº¦ Update</li> <li><code>markUpdateLaneFromFiberToRoot</code> ä»è§¦å‘æ›´æ–°çš„ fiber å‘ä¸Šéå†åˆ° rootFiber è§¦å‘æ·±åº¦ä¼˜å…ˆéå†</li> <li>è°ƒåº¦ rootFiberï¼Œ<code>ensureRootIsScheduled</code>ï¼Œæ ‡è®°è¿‡æœŸæœªæ‰§è¡Œçš„ç±»ï¼Œåˆ¤æ–­å½“å‰ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œè·å–å½“å‰ä¼˜å…ˆçº§æœ€é«˜çš„ç±»</li> <li>è°ƒåº¦ <code>performConcurrentWorkOnRoot</code> æˆ– <code>performSyncWorkOnRoot</code> è¿›å…¥ render é˜¶æ®µ</li></ul> <p>render é˜¶æ®µå…¥å£ performConcurrentWorkOnRoot</p> <p>commit é˜¶æ®µå…¥å£ commitRoot</p> <h3 id="update-è®¡ç®—"><a href="#update-è®¡ç®—" class="header-anchor">#</a> Update è®¡ç®—</h3> <p>ä½äºæœ¬æ¬¡æ›´æ–°ä¼˜å…ˆçº§çš„ state ä¸å‚ä¸è®¡ç®—ï¼Œè®¡ç®—å®Œä¹‹åä»¥æ–° state ä¸º initialstate æ¢å¤ä¸Šæ¬¡è®¡ç®—</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">Update</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token comment">//å¯¹è±¡ï¼ˆä¸¤ç§ FC,CCï¼‰ ä¿å­˜åœ¨ fiber.updateQueue ä¸­</span>
  eventTime<span class="token punctuation">,</span>
  lane<span class="token punctuation">,</span>
  suspenseConfig<span class="token punctuation">,</span>
  tag<span class="token punctuation">,</span> <span class="token comment">//æ›´æ–°ç±»å‹</span>
  payload<span class="token punctuation">,</span> <span class="token comment">//æ–°æ•°æ®</span>
  callback<span class="token punctuation">,</span> <span class="token comment">//æ›´æ–°å›è°ƒ</span>
  next
<span class="token punctuation">}</span>

<span class="token literal-property property">UpdateQueue</span><span class="token operator">:</span><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  firstBaseUpdate<span class="token punctuation">,</span>lastBaseUpdate<span class="token punctuation">,</span> <span class="token comment">//å·²å­˜åœ¨çš„ update é“¾è¡¨ï¼Œå¤´å°¾ï¼Œå¦‚ä¸Šæ¬¡è¢«æ‰“æ–­çš„ update</span>
  shared<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> <span class="token comment">//æœ¬æ¬¡æ›´æ–°äº§ç”Ÿçš„ Update ç¯çŠ¶é“¾è¡¨ï¼Œåœ¨ render é˜¶æ®µä¼šè¢«å‰ªå¼€ï¼Œè¿æ¥åˆ° lastBaseUpdate å</span>
  <span class="token literal-property property">effects</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span> callback
<span class="token punctuation">}</span>
</code></pre></div><p>éå† <code>updateQueue.baseUpdate</code> é“¾è¡¨ï¼Œä»¥ <code>updateQueue.baseState</code> ä¸ºåˆå§‹ stateï¼Œä¾æ¬¡è®¡ç®—äº§ç”Ÿæ–°çš„ stateï¼ˆmemoizedStateï¼‰</p> <p><strong>è¢«æ‰“æ–­çš„ä½ä¼˜å…ˆçº§ update å¦‚ä½•ä¸ä¸¢å¤±?</strong><br>
render é˜¶æ®µï¼š<br>
è¢«å‰ªå¼€çš„ç¯çŠ¶é“¾è¡¨ <code>shared.pending</code> ä¼šåŒæ—¶ä¿å­˜åœ¨ <code>workInProgress</code>å’Œ <code>current</code> çš„ <code>updateQueue.lastBaseUpdate</code> å<br>
è¢«ä¸­æ–­åé‡æ–°å¼€å§‹æ—¶ï¼Œä¼šåŸºäº <code>current</code> çš„ <code>updateQueue.lastBaseUpdate</code> å…‹éš†å‡º <code>workInProgress</code> çš„ <code>updateQueue</code>.<code>lastBaseUpdate</code>
commit é˜¶æ®µï¼š<br>
æ¸²æŸ“å®Œæˆï¼ŒworkInProgress å˜æˆ currentï¼Œä¹Ÿä¸ä¼šä¸¢å¤±</p> <p><strong>é«˜ä¼˜å…ˆçº§ update ä¼˜å…ˆè®¡ç®—å‡º state åŒæ—¶å¦‚ä½•ä¿æŒä¾èµ–è¿ç»­æ€§ï¼Ÿ</strong><br>
è¢«è·³è¿‡çš„ä½ä¼˜å…ˆçº§ update ä»¥åŠåé¢çš„æ‰€æœ‰ update ä¼šä½œä¸ºä¸‹ä¸€æ¬¡è®¡ç®—çš„ baseUpdateï¼Œå› æ­¤ä¸ä¼šä¸¢å¤±</p> <h3 id="ä¼˜å…ˆçº§è°ƒåº¦"><a href="#ä¼˜å…ˆçº§è°ƒåº¦" class="header-anchor">#</a> ä¼˜å…ˆçº§è°ƒåº¦</h3> <p>NoPriority 0 åˆå§‹åŒ–
ImmediatePriority 1 åŒæ­¥ï¼Œæœ€é«˜
UserBlockingPriority 2 ç”¨æˆ·äº¤äº’ ç‚¹å‡»äº‹ä»¶
NormalPriority 3 ajax
LowPrority 4 suspense
IdlePriority 5</p> <h2 id="hooks-é—­åŒ…ç¼ºé™·"><a href="#hooks-é—­åŒ…ç¼ºé™·" class="header-anchor">#</a> hooks é—­åŒ…ç¼ºé™·</h2> <p>ä¸ classComponents ä¸åŒï¼Œä¸æ˜¯ç”¨<code>this.</code>è·å– state çš„å€¼ï¼Œè€Œæ˜¯ç›´æ¥è·å–ï¼Œè¿™æ ·åœ¨ç±»ä¼¼ setTimeout çš„å‡½æ•°ä¸­è¯»å–çš„å€¼ä¸æ˜¯æœ€æ–°å€¼ã€‚<br>
functionComponents ä¸­ä½¿ç”¨ hooks å­˜å‚¨ã€æ›´æ–°çŠ¶æ€ï¼Œå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡é—­åŒ…è·å–çŠ¶æ€å€¼ï¼Œæ¯æ¬¡æ›´æ–°éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é—­åŒ…ã€‚<br>
é—­åŒ…ç¼ºé™·åˆ†ä¸ºä¸¤ç§ï¼š</p> <ul><li>useState çš„ setState å¯èƒ½å–ä¸åˆ°æœ€æ–°å€¼
é¿å…æ–¹æ³•ï¼šä½¿ç”¨å›è°ƒæ–¹å¼æ›´æ–°å€¼</li> <li>useEffect ä¸­åœ¨ setTimeout ä¸­è¯»å– stateï¼Œå–ä¸åˆ°æœ€æ–°å€¼
é¿å…æ–¹æ³•ï¼šï¼šæ·»åŠ ä¾èµ–ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½æ›´æ–°è¯»å–çš„è¿™ä¸ª state</li></ul> <h2 id="setstate-åŒæ­¥å¼‚æ­¥"><a href="#setstate-åŒæ­¥å¼‚æ­¥" class="header-anchor">#</a> setState åŒæ­¥å¼‚æ­¥</h2> <h3 id="reactv15"><a href="#reactv15" class="header-anchor">#</a> reactV15</h3> <ul><li>æ ¹æ® <code>excutionContext</code> æœ‰å€¼(Y å¼‚ N åŒ)ï¼Œåœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­åŒæ—¶è§¦å‘å¤šæ¬¡æ›´æ–°ï¼Œè¿™äº›æ›´æ–°ä¼šåˆå¹¶æˆä¸€æ¬¡æ›´æ–°</li> <li>æ ¹æ® <code>isBatchingUpdates</code> true(Y å¼‚ N åŒ)</li></ul> <p>åŒæ­¥æ›´æ–°/ä¸åˆå¹¶ï¼šåŸç”Ÿäº‹ä»¶ã€å¼‚æ­¥ä»£ç 
å¼‚æ­¥æ›´æ–°/åˆå¹¶ï¼šReact åˆæˆäº‹ä»¶ã€ç”Ÿå‘½å‘¨æœŸé’©å­ã€åœ¨åŸç”Ÿäº‹ä»¶å’Œå¼‚æ­¥ä»£ç ä¸­ä½¿ç”¨<code>ReactDOM.unstable_batchedUpdates</code></p> <h3 id="reactv16-8"><a href="#reactv16-8" class="header-anchor">#</a> reactV16.8</h3> <h2 id="æ—¶é—´åˆ‡ç‰‡"><a href="#æ—¶é—´åˆ‡ç‰‡" class="header-anchor">#</a> æ—¶é—´åˆ‡ç‰‡</h2> <p>FPS(frame per second) æ¯ç§’æ˜¾ç¤ºå¸§æ•°<br>
æµè§ˆå™¨ä¸€å¸§å¹²äº†äº›å•¥<br> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/13528958b6804c16a1dafb613d24b8a9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="fps"></p> <h3 id="requestframeanimation"><a href="#requestframeanimation" class="header-anchor">#</a> requestFrameAnimation</h3> <h4 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="header-anchor">#</a> åŸºæœ¬ç”¨æ³•</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">animation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  dom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginLeft <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
Window<span class="token punctuation">.</span><span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>æ¯ä¸€å¸§åªä¼šè°ƒç”¨ä¸€æ¬¡ rAF</p></blockquote> <h4 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="header-anchor">#</a> å…¼å®¹æ€§</h4> <p>ç†è®ºä¸Šä¸èƒ½ä½¿ç”¨ setTimeout å…œåº•ï¼š<br>
å½“æ‰§è¡Œå®Œ setTimeout å›è°ƒåï¼Œæµè§ˆå™¨å‘ç°è¿˜æœ‰æ—¶é—´ï¼Œäºæ˜¯åˆæ‰§è¡Œäº†å‡ æ¬¡ setTimeout å›è°ƒï¼Œæœ€åå†ä¸€èµ·æ¸²æŸ“ï¼Œæ‰€ä»¥åœ¨åŸæœ¬ä¸€å¸§çš„æ—¶é—´å†…æ‰§è¡Œäº†å¤šæ¬¡ setTimeout å›è°ƒï¼ŒåŠ¨ç”»è‡ªç„¶å°±ä¼šå¿«å¾ˆå¤šã€‚ä¸” setTimeout æœ‰æœ€ä½ 4ms å»¶æ—¶ã€‚</p> <h3 id="requestidlecallback"><a href="#requestidlecallback" class="header-anchor">#</a> requestIdleCallback</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">callback</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deadline<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token comment">//æ˜¯å¦åœ¨è¶…æ—¶å‰å·²å®Œæˆ</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//æœ¬æ¬¡ç©ºé—²å‘¨æœŸå†…å‰©ä½™æ—¶é—´</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handle <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">)</span>
Window<span class="token punctuation">.</span><span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span>  <span class="token comment">//å–æ¶ˆ</span>
</code></pre></div><ul><li>requestIdleCallback æ¯ç§’åªä¼šè¢«æ‰§è¡Œ 20 æ¬¡ï¼Œä¸€ä¸ªç©ºé—²å‘¨æœŸæœ€é•¿ 50ms</li> <li>ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é€‚ç”¨</li></ul> <h3 id="web-é€šä¿¡"><a href="#web-é€šä¿¡" class="header-anchor">#</a> web é€šä¿¡</h3> <p>éƒ½å±äºå®ä»»åŠ¡</p> <ol><li>è·¨æ–‡æ¡£é€šä¿¡ PostMessageï¼Œæ–¹æ³•å¯ä»¥å®‰å…¨åœ°å®ç°è·¨æºé€šä¿¡ã€‚</li> <li>é€šé“é€šä¿¡ MessageChannel</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="react-v16-0-0-raf-postmessage"><a href="#react-v16-0-0-raf-postmessage" class="header-anchor">#</a> react v16.0.0 rAF + postMessage</h3> <ol><li>è·å–å½“å‰å¸§æœ€æ™šç»“æŸæ—¶é—´ï¼ˆå½“å‰æ‰§è¡Œæ—¶é—´ + 33msï¼‰</li> <li>postmessage æ¨å…¥ä¸€ä¸ªä»»åŠ¡ï¼ˆå®Œæˆå…¶ä»–ä»»åŠ¡ä¹‹åï¼‰<br>
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ†“</li> <li>æ‰§è¡Œ messageListenr å›è°ƒ, è·å–å½“å‰å¸§å‰©ä½™æ—¶é—´</li> <li>å°†å‰©ä½™æ—¶é—´ä¼ å…¥åˆ° rAF çš„ callback å‡½æ•°ä¸­</li></ol> <blockquote><p>requestAnimationFrame() ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œä¼šå½±å“ react æ‰§è¡Œã€‚</p></blockquote> <h3 id="react-v16-2-0-messagechannel"><a href="#react-v16-2-0-messagechannel" class="header-anchor">#</a> react v16.2.0+ MessageChannel</h3> <p>flushWork è¿”å›æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡ PostMessageï¼Œè®©å‡ºçº¿ç¨‹ï¼Œå‘Šè¯‰æµè§ˆå™¨æ‰§è¡Œå®Œé«˜ä¼˜ä»»åŠ¡åç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåˆ‡ç‰‡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> currentTask<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentTask <span class="token operator">=</span> taskQueue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.ä»ä»»åŠ¡é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå¼€å§‹éå†æ‰§è¡Œ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.å·²æ— å‰©ä½™æ—¶é—´æˆ–ä¸»åŠ¨äº¤è¿˜æ‰§è¡Œæƒåˆ™è·³å‡ºéå†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> initialTime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.æ‰§è¡Œå›è°ƒã€ä»ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤è¯¥ä»»åŠ¡</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    taskQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentTask <span class="token operator">=</span> taskQueue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 4. è¿”å›æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// é»˜è®¤çš„æ—¶é—´åˆ‡ç‰‡</span>
<span class="token keyword">const</span> frameInterval <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// 5. å¦‚æœå½“å‰æ—¶é—´ - å¼€å§‹æ—¶é—´ï¼Œå³æ‰§è¡Œæ—¶é—´ï¼Œå¤§äºæ—¶é—´åˆ‡ç‰‡é¢„è®¾æ—¶é—´åˆ™ä¸»åŠ¨ä¸­æ–­</span>
<span class="token keyword">function</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeElapsed <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">&lt;</span> frameInterval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="render-é˜¶æ®µ"><a href="#render-é˜¶æ®µ" class="header-anchor">#</a> render é˜¶æ®µ</h2> <p>é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ï¼Œé€’å½’çš„æ–¹å¼éå†<br>
é€’é˜¶æ®µï¼š
éå†æ¯ä¸ªèŠ‚ç‚¹çš„ fiber è°ƒç”¨ beginWork æ–¹æ³•
mount:</p> <ul><li>æ ¹æ® fiber.tag åˆ›å»ºå½“å‰ fiber èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­ fiber èŠ‚ç‚¹</li> <li>æ ‡è®° effectTag</li></ul> <p>update:</p> <ul><li>æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶å…‹éš† current.child ä½œä¸º workInProgress.child</li> <li>diff</li> <li>åˆ›å»º fiber åˆå§‹åŒ– dom å±æ€§</li></ul> <p><strong>å½“éå†åˆ°å¶å­èŠ‚ç‚¹æ—¶å°±ä¼šè¿›å…¥åˆ°å½’é˜¶æ®µ</strong>
å½’é˜¶æ®µï¼šcompleteWork</p> <h3 id="diff"><a href="#diff" class="header-anchor">#</a> diff</h3> <p>æœ¬è´¨ï¼šå¯¹æ¯” current fiber å’Œ jsx å¯¹è±¡ï¼Œç”Ÿæˆ workInProgress Fiberã€‚æºç ä¸­çš„å…¥å£å‡½æ•°ä¸º reconcileChildFibers</p> <p>é™åˆ¶ï¼š</p> <ol><li>åŒçº§</li> <li>åŒç§å…ƒç´ </li> <li>å¯é€šè¿‡è®¾ç½® key æ‰“ç ´é™åˆ¶ 2</li></ol> <p>åˆ¤æ–­å½“å‰ newChild
å•ä¸€èŠ‚ç‚¹ï¼šæ˜¯å¦ React.Fragmentï¼Œæ˜¯å¦ Object<br>
å¤šèŠ‚ç‚¹: æ˜¯å¦ array</p> <p>diff åˆ†ä¸¤ç§æƒ…å†µï¼š</p> <ol><li>å•ä¸€èŠ‚ç‚¹ åˆ¤æ–­ key æ˜¯å¦ä¸€è‡´ã€åˆ¤æ–­æ˜¯å¦ä¸ºåŒç§å…ƒç´  â€ƒ--æ˜¯--&gt; æ ¹æ® currentfiber clone createFiber
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ â†“ å¦<br>
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ æ ‡è®°åˆ é™¤ dom,åˆ›å»º newfiber</li> <li>å¤šèŠ‚ç‚¹
å¯¹æ¯”æ›´æ–°å‰åçš„ nodeList,ä¸º node æ ‡è®° flag,éœ€è¦è€ƒè™‘æ˜¯ä»¥ä¸‹ä¸‰ç§æƒ…å†µçš„å“ªç§æƒ…å†µï¼š</li></ol> <ul><li><p>èŠ‚ç‚¹æ›´æ–°(å±æ€§å˜åŒ–)ã€ç±»å‹å˜åŒ–</p></li> <li><p>èŠ‚ç‚¹å¢åˆ </p></li> <li><p>èŠ‚ç‚¹ä½ç½®ç§»åŠ¨<br>
ä¸‰ç§æƒ…å†µçš„å¤„ç†é€»è¾‘ä¸åŒï¼Œ1 æƒ…å†µæ›´å¸¸è§ã€‚<br>
ç»å†ä¸¤è½®éå†ï¼Œé¦–è½®ä¼˜å…ˆå¤„ç†å¸¸è§æƒ…å†µ 1ï¼Œç¬¬äºŒè½®åå…¶ä»–æƒ…å†µã€‚</p> <p>æ•°ç»„ä¸æ•°ç»„å¯¹æ¯”ï¼Œé‡‡ç”¨åŒæŒ‡é’ˆçš„æ–¹å¼ï¼Œnewjsx æ•°ç»„å’Œ fiber é“¾è¡¨çš„æ¯”è¾ƒï¼Œé‡‡ç”¨ä¸¤è½®éå†ã€‚<br>
ç¬¬ä¸€è½®éå†ï¼šnewChildren[i] ä¸ oldFiber æ¯”è¾ƒï¼Œæ˜¯å¦å¯å¤ç”¨ï¼Œå¯å¤ç”¨ç»§ç»­æ¯”è¾ƒ newChildren[i+1] ä¸ oldFiber.subling
è·³å‡ºçš„æ¡ä»¶ï¼š</p> <ol><li>ä¸å¯å¤ç”¨ï¼š</li></ol> <ul><li>key ä¸åŒï¼Œç»“æŸç¬¬ä¸€è½®</li> <li>key ç›¸åŒï¼Œç±»å‹ä¸åŒï¼ŒoldFiber æ ‡è®° DELETIONï¼ŒåŸºäº jsx åˆ›å»ºæ–°çš„ fiberï¼Œç»§ç»­éå†</li></ul> <ol start="2"><li>newChildren éå†å®Œæˆ– oldFiber éå†å®Œæˆ–åŒæ—¶éå†å®Œ<br>
ç¬¬ä¸€è½®ç»“æŸè¿”å› resultingFirstChild, ç¬¬ä¸€ä¸ª workinprogressfiber</li></ol></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è™šæ‹ŸdomèŠ‚ç‚¹æ•°æ®ç»“æ„</span>
type flag <span class="token operator">=</span> <span class="token string">&quot;Placement&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;Deletion&quot;</span><span class="token punctuation">;</span> <span class="token comment">//Placementæ–°å¢æˆ–ç§»åŠ¨ï¼ŒDeletionåˆ é™¤</span>
<span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">//nodeçš„å”¯ä¸€æ ‡è¯†</span>
  flag<span class="token operator">?</span><span class="token operator">:</span> Flag<span class="token punctuation">;</span> <span class="token comment">// æ ‡è®°æ“ä½œç±»å‹</span>
  index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">//è¯¥nodeåœ¨åŒçº§nodeä¸­çš„ç´¢å¼•ä½ç½®</span>
<span class="token punctuation">}</span>

type NodeList <span class="token operator">=</span> Node<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">before</span><span class="token operator">:</span> NodeList<span class="token punctuation">,</span> <span class="token literal-property property">after</span><span class="token operator">:</span> NodeList</span><span class="token punctuation">)</span><span class="token operator">:</span> NodeList <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">result</span><span class="token operator">:</span>NodeList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// éå†å‰å‡†å¤‡å·¥ä½œ</span>
  <span class="token comment">// 1.éœ€è¦å­˜ä¸€ä»½beforeNode,ä¸”ä»¥O(1)å¤æ‚åº¦å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„node</span>
  <span class="token keyword">const</span> beforeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span>Node<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  before<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>index<span class="token operator">=</span>i<span class="token punctuation">;</span>
    beforeMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>key<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.éå†after,å¯¹æ¯”beforeï¼Œafterï¼Œéƒ½å­˜åœ¨çš„nodeï¼Œå¯å¤ç”¨ï¼Œå°†å­˜åœ¨ä¸¤ç§æƒ…å†µï¼šç§»åŠ¨ã€ä¸ç§»åŠ¨ï¼Œå¦‚ä½•åˆ¤æ–­ï¼Ÿ</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>after<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// éå†é€»è¾‘</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>demo1:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‰</span>
<span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// æ›´æ–°å</span>
<span class="token keyword">const</span> after <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;d&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">diff</span><span class="token punctuation">(</span>before<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
[
  {key:'a',flag:&quot;Deletion&quot;},
  {key:'d',flag:&quot;Placement&quot;}
]
*/</span>
</code></pre></div><p>demo2:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‰</span>
<span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token comment">// æ›´æ–°å</span>
<span class="token keyword">const</span> after <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token function">diff</span><span class="token punctuation">(</span>before<span class="token punctuation">,</span> after<span class="token punctuation">)</span> è¾“å‡º
<span class="token comment">/*
[
  {key: &quot;b&quot;, flag: &quot;Placement&quot;},
  {key: &quot;a&quot;, flag: &quot;Placement&quot;}
]

ç”±äºbä¹‹å‰å·²ç»å­˜åœ¨ï¼Œ{key: &quot;b&quot;, flag: &quot;Placement&quot;}ä»£è¡¨bå¯¹åº”DOMéœ€è¦å‘åç§»åŠ¨ï¼ˆå¯¹åº”parentNode.appendChildæ–¹æ³•ï¼‰ã€‚abcç»è¿‡è¯¥æ“ä½œåå˜ä¸ºacbã€‚

ç”±äºaä¹‹å‰å·²ç»å­˜åœ¨ï¼Œ{key: &quot;a&quot;, flag: &quot;Placement&quot;}ä»£è¡¨aå¯¹åº”DOMéœ€è¦å‘åç§»åŠ¨ã€‚acbç»è¿‡è¯¥æ“ä½œåå˜ä¸ºcbaã€‚

æ‰§è¡Œåçš„ç»“æœå°±æ˜¯ï¼šé¡µé¢ä¸­çš„abcå˜ä¸ºcbaã€‚
*/</span>
</code></pre></div><h2 id="commit-é˜¶æ®µ"><a href="#commit-é˜¶æ®µ" class="header-anchor">#</a> commit é˜¶æ®µ</h2> <h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h2> <h3 id="usestate"><a href="#usestate" class="header-anchor">#</a> useState</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> isMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//åœ¨reactä¸­é€šè¿‡currentFiberåˆ¤æ–­</span>
<span class="token keyword">const</span> workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">//å½“å‰æ­£åœ¨æ‰§è¡Œçš„hook</span>

<span class="token comment">// FCçš„fiber</span>
<span class="token keyword">const</span> <span class="token literal-property property">fiber</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">memorizedState</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//fiberä¸­ä¿å­˜çš„ç¬¬ä¸€ä¸ªhook</span>
  <span class="token literal-property property">stateNode</span><span class="token operator">:</span> å½“å‰<span class="token constant">FC</span>
<span class="token punctuation">}</span>

<span class="token comment">// è§¦å‘æ›´æ–°</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memorizedState
  <span class="token comment">// æ¨¡æ‹Ÿschedule render commitæµç¨‹</span>
  <span class="token comment">// éå†updateQueue,è®¡ç®—state</span>

  <span class="token comment">// renderã€commité˜¶æ®µ</span>
  <span class="token keyword">const</span> fc <span class="token operator">=</span> fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fc
<span class="token punctuation">}</span>

<span class="token comment">// å¤„ç†update</span>
<span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºupdate,å¹¶å­˜å…¥ç¯çŠ¶é“¾è¡¨ä¸­ hook.queue.pengding</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">,</span>
    <span class="token literal-property property">next</span><span class="token operator">:</span><span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending<span class="token operator">===</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ä¸å­˜åœ¨</span>
    <span class="token comment">// åˆ›å»ºç¯çŠ¶é“¾è¡¨ï¼Œé¦–å°¾æŒ‡å‘è‡ªå·±</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ’å…¥ç¯çŠ¶é“¾è¡¨ä¸­</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next
    queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update
  <span class="token punctuation">}</span>
    queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update
<span class="token punctuation">}</span>

<span class="token comment">// å¤„ç†hook</span>
<span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

<span class="token comment">// å‡†å¤‡å½“å‰hook</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isMount<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// ç¬¬ä¸€æ¬¡ åˆ›å»ºæ–°çš„hook</span>
    hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">pending</span><span class="token operator">:</span><span class="token keyword">null</span>  <span class="token comment">//TODO:æ˜¯update?</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">memorizedState</span><span class="token operator">:</span> initialState<span class="token punctuation">,</span>
      <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memorizedState<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// é¦–ä¸ªhook å­˜å…¥fiberä¸­</span>
      fiber<span class="token punctuation">.</span>memorizedState <span class="token operator">=</span> hook
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">// TODO: æ­¤å¤„workInProgressHook å·²æ˜¯fiber.memorizedStateï¼Ÿ</span>
      <span class="token comment">// å¦‚æœfiberä¸­æœ‰hookï¼Œåˆ™æŠŠå½“å‰çš„hookä½œä¸ºä¸‹ä¸€ä¸ªhook</span>
      workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰hook</span>
    hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next  <span class="token comment">//ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„hook</span>
  <span class="token punctuation">}</span>


<span class="token comment">// è®¡ç®—stateï¼Œæ ¹æ®memorizedState,å’Œupdateè®¡ç®—å‰©ä½™çš„update,newState</span>
  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memorizedState  <span class="token comment">//ä¸Šæ¬¡è®¡ç®—å¾—å‡ºçš„state</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next  <span class="token comment">//è¿™ä¸ªpendingä»å“ªæ¥</span>

<span class="token comment">// éå†hook.queue</span>
    <span class="token keyword">do</span><span class="token punctuation">{</span>
      <span class="token keyword">let</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action
      baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span>
      firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next
    <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">)</span>

    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  hook<span class="token punctuation">.</span>memorizedState <span class="token operator">=</span> baseState

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="useeffect"><a href="#useeffect" class="header-anchor">#</a> useEffect</h3> <p>Commit é˜¶æ®µï¼š</p> <ul><li>beforeMutation
æ£€æµ‹åˆ° useEffect,è°ƒåº¦ flushPassiveEffects</li> <li>mutation</li> <li>layout
æ³¨å†Œ destroyã€create åˆ° flushPassiveEffects ä¸Š</li> <li>commit å®Œæˆå
æ‰§è¡Œ flushPassiveEffectsï¼Œåˆ¤æ–­æ˜¯å¦ä¸º mount é˜¶æ®µï¼Œå³ current æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º nullï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ destroy</li></ul> <p>å¯¹äºé¡µé¢åˆ·æ–°ã€å…³é—­ã€è·³è½¬ç›¸å½“äºå®ä¾‹é”€æ¯ï¼Œäº useEffect æ— å…³ã€‚<br>
useEffect æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œå› ä¸ºä»æ£€æµ‹åˆ°å®é™…æ‰§è¡Œç»å†äº†å¤šä¸ªé˜¶æ®µï¼ŒåŸå› æ˜¯ï¼šé˜²æ­¢åŒæ­¥æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ¸²æŸ“ã€‚<br>
useLayoutEffect åˆ™æ˜¯åœ¨ mutation é˜¶æ®µæ‰§è¡Œ destroy å›è°ƒï¼Œåœ¨ layout é˜¶æ®µåŒæ­¥æ‰§è¡Œã€‚</p> <h2 id="context"><a href="#context" class="header-anchor">#</a> Context</h2> <p>å®šä¹‰ã€èµ‹å€¼ã€æ¶ˆè´¹<br>
React æ€§èƒ½ä¸€å¤§å…³é”®åœ¨äºï¼Œå‡å°‘ä¸å¿…è¦çš„ renderã€‚<br>
Context ä¼šé€šè¿‡ Object.is()ï¼Œå³ === æ¥æ¯”è¾ƒå‰å value æ˜¯å¦ä¸¥æ ¼ç›¸ç­‰ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›é™·é˜±ï¼šå½“æ³¨å†Œ Provider çš„çˆ¶ç»„ä»¶è¿›è¡Œé‡æ¸²æŸ“æ—¶ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹ç»„ä»¶è§¦å‘æ„å¤–æ¸²æŸ“ã€‚<br>
å½“æ¯ä¸€æ¬¡ Provider é‡æ¸²æŸ“æ—¶ï¼Œä»¥ä¸‹çš„ä»£ç ä¼šé‡æ¸²æŸ“æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶ï¼Œå› ä¸º value å±æ€§æ€»æ˜¯è¢«èµ‹å€¼ä¸ºæ–°çš„å¯¹è±¡ã€‚</p> <p>å½“ context value å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆè¿™é‡Œä½¿ç”¨çš„æ˜¯ Object.isï¼Œé€šå¸¸æˆ‘ä»¬ä¼ é€’çš„ value éƒ½æ˜¯ä¸€ä¸ªå¤æ‚å¯¹è±¡ç±»å‹ï¼Œå®ƒå°†æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€æ˜¯å¦ç›¸åŒï¼Œè‹¥å¼•ç”¨åœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¼šè¿›å…¥ bailout å¤ç”¨å½“å‰ Fiber èŠ‚ç‚¹ï¼Œåœ¨ bailout ä¸­ï¼Œä¼šæ£€æŸ¥è¯¥ Fiber çš„æ‰€æœ‰å­å­™ Fiber æ˜¯å¦å­˜åœ¨ lane æ›´æ–°ã€‚è‹¥æ‰€æœ‰å­å­™ Fiber æœ¬æ¬¡éƒ½æ²¡æœ‰æ›´æ–°éœ€è¦æ‰§è¡Œï¼Œåˆ™ bailout ä¼šç›´æ¥è¿”å› nullï¼Œæ•´æ£µå­æ ‘éƒ½è¢«è·³è¿‡æ›´æ–°ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ›´æ–°ï¼Œå¹¶è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†å­èŠ‚ç‚¹ï¼Œæ£€æŸ¥æ¶ˆè´¹ç»„ä»¶ fiber ä¸­çš„ dependenceï¼Œéå†å¯¹æ¯”å½“å‰æ›´æ–°çš„ contextï¼Œå¦‚æœä¸€è‡´åˆ™æ ‡è®°è¯¥ fiber çš„ lane å±æ€§ï¼Œ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ctx<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ctx<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ctx<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Cpn <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* 3 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ctx<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Cpn <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* 2 */</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ctx<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Cpn <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* 1 */</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ctx<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Cpn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> num <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">initialValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_CONTEXT_TYPE</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_currentValue</span><span class="token operator">:</span> initialValue<span class="token punctuation">,</span>
    <span class="token literal-property property">Provider</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// context.Provider = ({ children, value }) =&gt; {</span>
  <span class="token comment">//   context.value = value;</span>
  <span class="token comment">//   return &lt;div&gt;{children}&lt;/div&gt;;</span>
  <span class="token comment">// };</span>

  context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_PROVIDER_TYPE</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_context</span><span class="token operator">:</span> context<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

   context<span class="token punctuation">.</span>Consumer <span class="token operator">=</span> context<span class="token punctuation">;</span>

  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useContext</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> contextItem <span class="token operator">=</span> <span class="token punctuation">{</span>
    context
    <span class="token literal-property property">next</span><span class="token operator">:</span><span class="token keyword">null</span> <span class="token comment">//é“¾è¡¨ï¼ŒåŒä¸€ç»„ä»¶ä¸Šæ³¨å†Œçš„å¤šä¸ªcontext</span>
  <span class="token punctuation">}</span>
<span class="token comment">// æ˜¯å¦å·²æœ‰context</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>lastContextDependency<span class="token operator">===</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   lastContextDependency <span class="token operator">=</span> contextItem<span class="token punctuation">;</span>
   currentlyRenderFiber<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lanes</span><span class="token operator">:</span> NoLanes<span class="token punctuation">,</span>
    <span class="token literal-property property">firstContext</span><span class="token operator">:</span> contextItem<span class="token punctuation">,</span>
    <span class="token literal-property property">responders</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  lastContextDependency <span class="token operator">=</span> lastContextDependency<span class="token punctuation">.</span>next <span class="token operator">=</span> contextItem
<span class="token punctuation">}</span>
  <span class="token keyword">return</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> preContextValueStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> preContextValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">pushProvider</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  preContextValueStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>preContextValue<span class="token punctuation">.</span>_currentValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

  preContextValue <span class="token operator">=</span> newContext<span class="token punctuation">.</span>_currentValue<span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">popProvider</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> preContextValue<span class="token punctuation">;</span>
  preContextValue <span class="token operator">=</span> preContextValueStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> scheduler</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">8/31/2023, 2:51:12 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a8c5bfd.js" defer></script><script src="/assets/js/2.dec9ee96.js" defer></script><script src="/assets/js/29.d0462958.js" defer></script>
  </body>
</html>
